<!-- Testimonials Management Page -->
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-chat-quote me-2"></i>Testimonials</h2>
            <p class="text-muted mb-0">Manage customer testimonials displayed on the website</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testimonialModal" onclick="resetForm()">
            <i class="bi bi-plus-lg me-1"></i> Add Testimonial
        </button>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <!-- Testimonials Table -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-table me-2"></i>All Testimonials
            <span class="badge bg-primary ms-2" id="testimonialCount">0</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:60px">Avatar</th>
                            <th style="width:80px">Story</th>
                            <th>Name</th>
                            <th>Country</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th style="width:140px">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="testimonialTableBody">
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <div class="spinner-border spinner-border-sm me-2"></div> Loading testimonials...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Testimonial Modal -->
<div class="modal fade" id="testimonialModal" tabindex="-1" aria-labelledby="testimonialModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testimonialModalLabel">Add Testimonial</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="testimonialForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="hidden" id="testimonialId" value="">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="testimonialName" class="form-label">Name <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="testimonialName" name="name" required
                                placeholder="e.g. Sarah K.">
                        </div>
                        <div class="col-md-6">
                            <label for="testimonialCountry" class="form-label">Country <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="testimonialCountry" name="country" required
                                placeholder="e.g. United States">
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="testimonialAvatar" class="form-label">Tourist Photo (Avatar)</label>
                            <input type="file" class="form-control" id="testimonialAvatar" name="avatar"
                                accept="image/*">
                            <small class="text-muted">Small profile photo of the tourist</small>
                            <div id="avatarPreview" class="mt-2" style="display:none;">
                                <img src="" alt="Avatar preview"
                                    style="width:60px;height:60px;border-radius:50%;object-fit:cover;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="testimonialStoryImage" class="form-label">Story Image (Portrait) <span
                                    class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="testimonialStoryImage" name="storyImage"
                                accept="image/*">
                            <small class="text-muted">Portrait image (9:16 aspect ratio recommended)</small>
                            <div id="storyPreview" class="mt-2" style="display:none;">
                                <img src="" alt="Story preview"
                                    style="width:80px;height:142px;border-radius:8px;object-fit:cover;">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">
                        <i class="bi bi-check-lg me-1"></i> Save Testimonial
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-trash me-2"></i>Delete Testimonial</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this testimonial? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    let editingId = null;
    let deleteId = null;

    // Load testimonials on page load
    document.addEventListener('DOMContentLoaded', loadTestimonials);

    async function loadTestimonials() {
        try {
            const res = await fetch('/api/testimonials');
            const testimonials = await res.json();
            renderTable(testimonials);
            document.getElementById('testimonialCount').textContent = testimonials.length;
        } catch (err) {
            console.error('Error loading testimonials:', err);
            document.getElementById('testimonialTableBody').innerHTML =
                '<tr><td colspan="7" class="text-center py-4 text-danger">Failed to load testimonials</td></tr>';
        }
    }

    function renderTable(testimonials) {
        const tbody = document.getElementById('testimonialTableBody');
        if (!testimonials.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">No testimonials yet. Click "Add Testimonial" to create one.</td></tr>';
            return;
        }

        tbody.innerHTML = testimonials.map(function (t) {
            const avatarHtml = t.avatarUrl
                ? '<img src="' + t.avatarUrl + '" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" alt="Avatar">'
                : '<div style="width:40px;height:40px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;"><i class="bi bi-person"></i></div>';

            const storyHtml = t.storyImgUrl
                ? '<img src="' + t.storyImgUrl + '" style="width:45px;height:80px;border-radius:6px;object-fit:cover;" alt="Story">'
                : '<div style="width:45px;height:80px;border-radius:6px;background:#e5e7eb;display:flex;align-items:center;justify-content:center;"><i class="bi bi-image"></i></div>';

            var statusBadge = t.active
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-secondary">Inactive</span>';

            var date = new Date(t.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            return '<tr>' +
                '<td>' + avatarHtml + '</td>' +
                '<td>' + storyHtml + '</td>' +
                '<td><strong>' + t.name + '</strong></td>' +
                '<td>' + t.country + '</td>' +
                '<td>' + statusBadge + '</td>' +
                '<td><small class="text-muted">' + date + '</small></td>' +
                '<td>' +
                '<button class="btn btn-sm btn-outline-primary me-1" onclick="editTestimonial(\'' + t._id + '\')" title="Edit"><i class="bi bi-pencil"></i></button>' +
                '<button class="btn btn-sm btn-outline-' + (t.active ? 'warning' : 'success') + ' me-1" onclick="toggleActive(\'' + t._id + '\',' + !t.active + ')" title="' + (t.active ? 'Deactivate' : 'Activate') + '"><i class="bi bi-' + (t.active ? 'eye-slash' : 'eye') + '"></i></button>' +
                '<button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal(\'' + t._id + '\')" title="Delete"><i class="bi bi-trash"></i></button>' +
                '</td>' +
                '</tr>';
        }).join('');
    }

    function resetForm() {
        editingId = null;
        document.getElementById('testimonialId').value = '';
        document.getElementById('testimonialForm').reset();
        document.getElementById('testimonialModalLabel').textContent = 'Add Testimonial';
        document.getElementById('avatarPreview').style.display = 'none';
        document.getElementById('storyPreview').style.display = 'none';
    }

    async function editTestimonial(id) {
        try {
            const res = await fetch('/api/testimonials');
            const testimonials = await res.json();
            const t = testimonials.find(function (item) { return item._id === id; });
            if (!t) return;

            editingId = id;
            document.getElementById('testimonialId').value = id;
            document.getElementById('testimonialName').value = t.name;
            document.getElementById('testimonialCountry').value = t.country;
            document.getElementById('testimonialModalLabel').textContent = 'Edit Testimonial';

            // Show existing image previews
            if (t.avatarUrl) {
                var avatarPrev = document.getElementById('avatarPreview');
                avatarPrev.style.display = 'block';
                avatarPrev.querySelector('img').src = t.avatarUrl;
            }
            if (t.storyImgUrl) {
                var storyPrev = document.getElementById('storyPreview');
                storyPrev.style.display = 'block';
                storyPrev.querySelector('img').src = t.storyImgUrl;
            }

            var modal = new bootstrap.Modal(document.getElementById('testimonialModal'));
            modal.show();
        } catch (err) {
            showAlert('Failed to load testimonial for editing', 'danger');
        }
    }

    // Form submit handler
    document.getElementById('testimonialForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        var formData = new FormData();
        formData.append('name', document.getElementById('testimonialName').value);
        formData.append('country', document.getElementById('testimonialCountry').value);

        var avatarFile = document.getElementById('testimonialAvatar').files[0];
        var storyFile = document.getElementById('testimonialStoryImage').files[0];

        if (avatarFile) formData.append('avatar', avatarFile);
        if (storyFile) formData.append('storyImage', storyFile);

        var url = editingId ? '/api/testimonials/' + editingId : '/api/testimonials';
        var method = editingId ? 'PUT' : 'POST';

        try {
            var res = await fetch(url, { method: method, body: formData });
            if (!res.ok) throw new Error('Request failed');

            bootstrap.Modal.getInstance(document.getElementById('testimonialModal')).hide();
            showAlert(editingId ? 'Testimonial updated successfully' : 'Testimonial created successfully', 'success');
            loadTestimonials();
            resetForm();
        } catch (err) {
            showAlert('Failed to save testimonial', 'danger');
        }
    });

    async function toggleActive(id, newState) {
        try {
            var formData = new FormData();
            formData.append('active', newState);
            formData.append('name', ''); // required field placeholder
            formData.append('country', ''); // required field placeholder

            // Fetch current data first to preserve fields
            var allRes = await fetch('/api/testimonials');
            var all = await allRes.json();
            var current = all.find(function (t) { return t._id === id; });
            if (current) {
                formData.set('name', current.name);
                formData.set('country', current.country);
            }

            var res = await fetch('/api/testimonials/' + id, { method: 'PUT', body: formData });
            if (!res.ok) throw new Error('Request failed');
            showAlert('Testimonial ' + (newState ? 'activated' : 'deactivated'), 'success');
            loadTestimonials();
        } catch (err) {
            showAlert('Failed to update testimonial', 'danger');
        }
    }

    function showDeleteModal(id) {
        deleteId = id;
        var modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', async function () {
        if (!deleteId) return;
        try {
            var res = await fetch('/api/testimonials/' + deleteId, { method: 'DELETE' });
            if (!res.ok) throw new Error('Request failed');
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            showAlert('Testimonial deleted successfully', 'success');
            loadTestimonials();
        } catch (err) {
            showAlert('Failed to delete testimonial', 'danger');
        }
        deleteId = null;
    });

    // Image preview on file select
    document.getElementById('testimonialAvatar').addEventListener('change', function () {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var prev = document.getElementById('avatarPreview');
                prev.style.display = 'block';
                prev.querySelector('img').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('testimonialStoryImage').addEventListener('change', function () {
        var file = this.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var prev = document.getElementById('storyPreview');
                prev.style.display = 'block';
                prev.querySelector('img').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    function showAlert(message, type) {
        var container = document.getElementById('alertContainer');
        container.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
            message +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
            '</div>';
        setTimeout(function () { container.innerHTML = ''; }, 4000);
    }
</script>